{% extends "layout.html" %}
{% load static %}

{% block title %}
Chat with GPT
{% endblock %}

{% block content %}
<head>
    <!-- Favicon -->
    <link href={% static "img/favicon.ico" %} rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href={%static  "lib/animate/animate.min.css" %} rel="stylesheet">
    <link href={%static "lib/owlcarousel/assets/owl.carousel.min.css" %}  rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href={%static "css/bootstrap.min.css" %} rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href={%static "css/style.css" %} rel="stylesheet">
    <link href={%static "css/animate.css" %} rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    body{
        background: #9053c7;
    background: -webkit-linear-gradient(-135deg, #c850c0, #4158d0);
    background: -o-linear-gradient(-135deg, #c850c0, #4158d0);
    background: -moz-linear-gradient(-135deg, #c850c0, #4158d0);
    background: linear-gradient(-135deg, #c850c0, #4158d0);

    }
</style>
</head>
<div class="chat-limiter">
    <div class="chat-container" style="margin-top: 20px;">
        <div class="chat-messages" id="chat-messages">
            {% if conversation %}
                {% for message in conversation %}
                    <div class="chat-message {% if message.role == 'user' %}chat-user{% else %}chat-assistant{% endif %}">
                        {% if message.content|slice:":3" == '```' and message.content|slice:"-3:" == '```' %}
                            <div class="code-container">
                                <pre><code class="language-python">{{ message.content|slice:"3:-3" }}</code></pre>
                            </div>
                        {% else %}
                            {{ message.content }}
                        {% endif %}
                        {% if message.role == 'assistant' %}
                            <form method="post" action="{% url 'save_question' %}" class="save-question-form mt-3">
                                {% csrf_token %}
                                <input type="hidden" name="question_text" value="{{ message.content }}">
                                <div class="mb-3 level-container" style="display: none;">
                                    <label for="questionLevel{{ forloop.counter }}" class="form-label">Select Level</label>
                                    <select class="form-select" id="questionLevel{{ forloop.counter }}" name="level" required>
                                        <option value="" disabled selected>Select level</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <div class="confirmation-buttons" style="display: none;">
                                    <button type="button" class="btn btn-success confirm-save">Yes</button>
                                    <button type="button" class="btn btn-danger cancel-save">No</button>
                                </div>
                                <button type="button" class="btn btn-primary show-level">Save Question</button>
                            </form>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="chat-welcome-message">Start your conversation!</div>
            {% endif %}
        </div>
        <form method="post" action="{% url 'chat_page' %}" class="chat-form">
            {% csrf_token %}
            <div class="input-group mb-3 d-flex align-items-center">
                <input type="text" class="form-control" id="message" name="message" placeholder="Type your message here..." required>
                <button class="btn btn-primary" type="submit">
                    <i class="fa fa-paper-plane"></i>
                </button>
                <!-- Command Button -->
                <button class="btn btn-custom info-button ms" type="button" data-bs-toggle="modal" data-bs-target="#commandsModal">
                    <i class="fa fa-list"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Commands Modal -->
<div class="modal fade" id="commandsModal" tabindex="-1" aria-labelledby="commandsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commandsModalLabel">Possible Commands</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    <li>To get Code Snippets use: write code or write some code</li>
                    <li>Clear chat (clears the chat)</li>
                    <!-- Add more commands as needed -->
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded and parsed");
    
        document.querySelectorAll('.show-level').forEach(function(button) {
            console.log("Attaching event listener to show-level button");
    
            button.addEventListener('click', function() {
                console.log("Show-level button clicked");
                const form = button.closest('form');
                form.querySelector('.level-container').style.display = 'block';
                form.querySelector('.confirmation-buttons').style.display = 'block';
                button.style.display = 'none';
            });
        });
    
        document.querySelectorAll('.confirm-save').forEach(function(button) {
            console.log("Attaching event listener to confirm-save button");
    
            button.addEventListener('click', function() {
                console.log("Confirm-save button clicked");
                const form = button.closest('form');
                form.submit();
            });
        });
    
        document.querySelectorAll('.cancel-save').forEach(function(button) {
            console.log("Attaching event listener to cancel-save button");
    
            button.addEventListener('click', function() {
                console.log("Cancel-save button clicked");
                const form = button.closest('form');
                form.querySelector('.level-container').style.display = 'none';
                form.querySelector('.confirmation-buttons').style.display = 'none';
                form.querySelector('.show-level').style.display = 'block';
            });
        });
    });
    </script>
{% endblock %}


